#ifndef CAN_CANOPEN_H_INCLUDED
#define CAN_CANOPEN_H_INCLUDED

#define  COB_NMT	CAN_ID_STDID(0x000)
#define  COB_SYNC	CAN_ID_STDID(0x080)
#define  COB_EMCY(id)	CAN_ID_STDID(0x080 | id)
#define  COB_TIME	CAN_ID_STDID(0x100)
#define  COB_TPDO1(id)	CAN_ID_STDID(0x180 | id)
#define  COB_RPDO1(id)	CAN_ID_STDID(0x200 | id)
#define  COB_TPDO2(id)	CAN_ID_STDID(0x280 | id)
#define  COB_RPDO2(id)	CAN_ID_STDID(0x300 | id)
#define  COB_TPDO3(id)	CAN_ID_STDID(0x380 | id)
#define  COB_RPDO3(id)	CAN_ID_STDID(0x400 | id)
#define  COB_TPDO4(id)	CAN_ID_STDID(0x480 | id)
#define  COB_RPDO4(id)	CAN_ID_STDID(0x500 | id)
#define  COB_TSDO(id)	CAN_ID_STDID(0x580 | id)
#define  COB_RSDO(id)	CAN_ID_STDID(0x600 | id)
#define  COB_GUARD(id)	CAN_ID_STDID(0x700 | id)

enum {
	CANOPEN_NMT_CMD_START = 1,
	CANOPEN_NMT_CMD_STOP = 2,
	CANOPEN_NMT_CMD_ENTER_PREOP = 128,
	CANOPEN_NMT_CMD_RESET_NODE = 129,
	CANOPEN_NMT_CMD_RESET_COMM = 130,
};

enum {
	CANOPEN_NMT_STATE_INITIALISING = 0,
	CANOPEN_NMT_STATE_DISCONNECTED = 1,
	CANOPEN_NMT_STATE_CONNECTING = 2,
	CANOPEN_NMT_STATE_PREPARING = 3,
	CANOPEN_NMT_STATE_STOPPED = 4,
	CANOPEN_NMT_STATE_OPERATIONAL = 5,
	CANOPEN_NMT_STATE_PRE_OPERATIONAL = 127,
};

#define CANOPEN_NMT_STATE	0x7F
#define CANOPEN_NMT_TOGGLE	0x80

#define CANOPEN_ERROR_GENERIC			(1 << 0)
#define CANOPEN_ERROR_CURRENT			(1 << 1)
#define CANOPEN_ERROR_VOLTAGE			(1 << 2)
#define CANOPEN_ERROR_TEMPERATURE		(1 << 3)
#define CANOPEN_ERROR_COMMUNICATION		(1 << 4)
#define CANOPEN_ERROR_DEVICE_SPECIFIC		(1 << 5)
#define CANOPEN_ERROR_MANUF_SPECIFIC		(1 << 7)

#define CANOPEN_SDOABORT_TOGGLE_BIT_NOT_ALTERNATED		0x05030000
#define CANOPEN_SDOABORT_PROTOCOL_TIMEOUT			0x05040000
#define CANOPEN_SDOABORT_UNKNOWN_SPECIFIER			0x05040001
#define CANOPEN_SDOABORT_INVALID_BLOCK_SIZE			0x05040002
#define CANOPEN_SDOABORT_INVALID_SEQN				0x05040003
#define CANOPEN_SDOABORT_CRC_ERROR				0x05040004
#define CANOPEN_SDOABORT_OUT_OF_MEMORY				0x05040005
#define CANOPEN_SDOABORT_UNSUPPORTED_ACCESS			0x06010000
#define CANOPEN_SDOABORT_READ_WRITEONLY				0x06010001
#define CANOPEN_SDOABORT_WRITE_READONLY				0x06010002
#define CANOPEN_SDOABORT_OBJECT_NONEXIST			0x06020000
#define CANOPEN_SDOABORT_PDO_OBJECT_CANNOTMAP			0x06040041
#define CANOPEN_SDOABORT_PDO_LONG_LENGTH			0x06040042
#define CANOPEN_SDOABORT_PARAM_INCOMPATIBLE			0x06040043
#define CANOPEN_SDOABORT_DEVICE_INCOMATIBLE			0x06040047
#define CANOPEN_SDOABORT_HARDWARE_ERROR				0x06060000
#define CANOPEN_SDOABORT_PARAM_LEN_INVALID			0x06060010
#define CANOPEN_SDOABORT_PARAM_LEN_HIGH				0x06060012
#define CANOPEN_SDOABORT_PARAM_LEN_LOW				0x06060013
#define CANOPEN_SDOABORT_SUBIDX_NOTEXIST			0x06090011
#define CANOPEN_SDOABORT_VALUE_RANGE_EXCEEDED			0x06090030
#define CANOPEN_SDOABORT_VALUE_TOO_HIGH				0x06090031
#define CANOPEN_SDOABORT_VALUE_TOO_LOW				0x06090032
#define CANOPEN_SDOABORT_MAXMIN_INVALID				0x06090036
#define CANOPEN_SDOABORT_GENERAL_ERROR				0x08000000
#define CANOPEN_SDOABORT_CANNOT_STORE				0x08000020
#define CANOPEN_SDOABORT_CANNOT_STORE_LOCAL_CONTROL		0x08000021
#define CANOPEN_SDOABORT_CANNOT_STORE_STATE			0x08000022
#define CANOPEN_SDOABORT_OD_GENERATION_FAIL			0x08000023

#define CANOPEN_EMCY_NO_ERROR			0x0000
#define CANOPEN_EMCY_GENERIC			0x1000
#define CANOPEN_EMCY_CURRENT			0x2000
#define CANOPEN_EMCY_CURRENT_INPUT		0x2100
#define CANOPEN_EMCY_CURRENT_INSIDE		0x2200
#define CANOPEN_EMCY_CURRENT_OUTPUT		0x2300
#define CANOPEN_EMCY_VOLTAGE			0x3000
#define CANOPEN_EMCY_VOLTAGE_INPUT		0x3100
#define CANOPEN_EMCY_VOLTAGE_INSIDE		0x3200
#define CANOPEN_EMCY_VOLTAGE_OUTPUT		0x3300
#define CANOPEN_EMCY_TEMP			0x4000
#define CANOPEN_EMCY_TEMP_AMBIENT		0x4100
#define CANOPEN_EMCY_TEMP_DEVICE		0x4200
#define CANOPEN_EMCY_DEVICE_HW			0x5000
#define CANOPEN_EMCY_DEVICE_SW			0x6000
#define CANOPEN_EMCY_DEVICE_SW_INTERNAL		0x6100
#define CANOPEN_EMCY_DEVICE_SW_USER		0x6200
#define CANOPEN_EMCY_DEVICE_SW_DATA		0x6300
#define CANOPEN_EMCY_MODULES			0x7000
#define CANOPEN_EMCY_MON			0x8000
#define CANOPEN_EMCY_MON_COMM			0x8100
#define CANOPEN_EMCY_MON_COMM_CANOVERUN		0x8110
#define CANOPEN_EMCY_MON_COMM_CANPASSIVE	0x8120
#define CANOPEN_EMCY_MON_COMM_HEARTBEAT		0x8130
#define CANOPEN_EMCY_MON_COMM_BUSOFFRECOV	0x8140
#define CANOPEN_EMCY_MON_PROTO			0x8200
#define CANOPEN_EMCY_MON_PROTO_PDOLENERR	0x8210
#define CANOPEN_EMCY_MON_PROTO_LENEXCEED	0x8220
#define CANOPEN_EMCY_EXTERNAL			0x9000
#define CANOPEN_EMCY_ADDITIONAL_FUNC		0xF000
#define CANOPEN_EMCY_DEVICE_SPECIFIC		0xFF00

static inline
void canopen_sync(uint32_t canport)
{
	can_transmit(canport, COB_SYNC, NULL, 0);
}

static inline
void canopen_nmt(uint32_t canport, uint8_t id, uint8_t cmd)
{
	uint8_t data[2] = { id, cmd };
	can_transmit(canport, COB_NMT, data, 2);
}
#endif // CAN_CANOPEN_H_INCLUDED
